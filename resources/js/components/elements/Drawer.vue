<template xmlns="http://www.w3.org/1999/html">
    <div v-cloak>
        <button type="button" @click="toggle"
                class="mdc-icon-button material-icons mdc-button--raised fixed left-0 top-area-inset-top mt-1 p-2 mt-2 ml-2 z-5 !bg-dark-gray2-75 rounded-full">
            menu
        </button>

        <aside ref="menu" class="mdc-drawer mdc-drawer--modal">
            <div class="mdc-drawer__header" style="min-height: 0;">
                <a href="/">
                    <webp class="w-3/4 mt-4" alt="Gloomhaven" src="/img/gloomhaven-logo.png"/>
                </a>
            </div>
            <div class="mdc-drawer__content">
                <div class="mdc-list-group">
                    <!--
                    <div v-if="user" class="mx-4 mb-4 flex items-center">
                        <span class="inline-block h-10 w-10 rounded-full overflow-hidden bg-gray-50">
                            <img class="h-full w-full"
                                 :src="gravatar()"/>
                        </span>
                        <div class="text-white2-87 flex-1 ml-4 flex flex-col">
                            <span class="text-lg">{{ user.name }}</span>
                            <span class="text-sm">{{ user.email }}</span>
                        </div>
                    </div>
                    -->

                    <ul ref="list" class="mdc-list">
                        <li @click="toggle">
                            <router-link to="/campaigns" class="mdc-list-item"
                                         active-class="mdc-list-item--activated">
                                <i class="material-icons mdc-list-item__graphic"
                                   aria-hidden="true">supervisor_account</i>
                                <span class="mdc-list-item__text">
                                    {{ $t('Campaigns') }}
                                    <span v-if="!user" class="ml-2 text-gold font-bold">{{ $t('Pro') }}</span>
                                </span>
                            </router-link>
                        </li>

                        <li role="separator" class="mdc-list-divider !my-2"></li>

                        <li @click="toggle">
                            <router-link to="/story" class="mdc-list-item" active-class="mdc-list-item--activated">
                                <inline-svg src="icons/story" class="mdc-list-item__graphic" aria-hidden="true"/>
                                <span class="mdc-list-item__text">{{ $t('Storyline') }}</span>
                            </router-link>
                        </li>

                        <li v-if="hasMap" @click="toggle">
                            <router-link to="/map" class="mdc-list-item" active-class="mdc-list-item--activated">
                                <i class="material-icons mdc-list-item__graphic" aria-hidden="true">map</i>
                                <span class="mdc-list-item__text">{{ $t('Map') }}</span>
                            </router-link>
                        </li>

                        <li @click="toggle">
                            <router-link to="/scenarios" class="mdc-list-item"
                                         active-class="mdc-list-item--activated">
                                <i class="material-icons mdc-list-item__graphic" aria-hidden="true">list</i>
                                <span class="mdc-list-item__text">{{ $t('Scenario list') }}</span>
                            </router-link>
                        </li>

                        <li @click="toggle">
                            <router-link to="/achievements" class="mdc-list-item"
                                         active-class="mdc-list-item--activated">
                                <inline-svg style="width: 16px" src="icons/achievements"
                                            class="mdc-list-item__graphic ml-1"
                                            aria-hidden="true"/>
                                <span class="mdc-list-item__text">{{ $t('Achievements') }}</span>
                            </router-link>
                        </li>

                        <li @click="toggle">
                            <router-link to="/party" class="mdc-list-item"
                                         active-class="mdc-list-item--activated">
                                <i class="material-icons mdc-list-item__graphic" aria-hidden="true">assignment</i>
                                <span class="mdc-list-item__text">{{ $t('Party sheet') }}</span>
                            </router-link>
                        </li>

                        <li @click="toggle">
                            <router-link to="/characters" class="mdc-list-item"
                                         active-class="mdc-list-item--activated">
                                <i class="material-icons mdc-list-item__graphic"
                                   aria-hidden="true">person</i>
                                <span class="mdc-list-item__text">{{ $t('Character sheet') }}</span>
                            </router-link>
                        </li>

                        <li @click="toggle">
                            <router-link to="/items" class="mdc-list-item"
                                         active-class="mdc-list-item--activated">
                                <i class="material-icons mdc-list-item__graphic transform rotate-180"
                                   aria-hidden="true">style</i>
                                <span class="mdc-list-item__text">{{ $t('Items') }}</span>
                            </router-link>
                        </li>

                        <li role="separator" class="mdc-list-divider !my-2"></li>
                    </ul>
                </div>
                <div class="mdc-list-group">
                    <ul>
                        <li>
                            <a class="mdc-list-item"
                               @click="shareCurrentStory">
                                <i class="material-icons mdc-list-item__graphic" aria-hidden="true">share</i>
                                <span class="mdc-list-item__text">{{ $t('Share') }}</span>
                            </a>
                        </li>

                        <li role="separator" class="mdc-list-divider !my-2"></li>
                    </ul>
                </div>

                <links @click="toggle" class="px-4 -my-2"></links>

                <div class="mdc-list-group">
                    <ul>
                        <li role="separator" class="mdc-list-divider !my-2"></li>

                        <li @click="toggle">
                            <router-link to="/info" class="mdc-list-item" active-class="mdc-list-item--activated">
                                <i class="material-icons mdc-list-item__graphic"
                                   aria-hidden="true">info</i>
                                <span class="mdc-list-item__text">{{ $t('Info') }}</span>
                            </router-link>
                        </li>

                        <li @click="toggle">
                            <router-link to="/settings" class="mdc-list-item"
                                         active-class="mdc-list-item--activated">
                                <i class="material-icons mdc-list-item__graphic" aria-hidden="true">settings</i>
                                <span class="mdc-list-item__text">{{ $t('Settings') }}</span>
                            </router-link>
                        </li>

                        <li role="separator" class="mdc-list-divider !my-2"></li>

                    </ul>
                </div>

                <div v-if="showCampaignSwitch" class="m-2" style="width: calc(100% - 1em);">
                    <campaign-switch ref="campaign-switch"></campaign-switch>
                </div>
                <div class="m-2" style="width: calc(100% - 1em);">
                    <game-switch ref="game-switch"></game-switch>
                </div>

                <div class="mdc-list-group">
                    <ul>
                        <li v-if="!loggedIn" class="py-4 pl-4 flex" @click="toggle">
                            <become-patron-button transparent></become-patron-button>
                        </li>

                        <li v-if="!loggedIn" class="py-4 pl-4 w-full" @click="toggle">
                            <donate></donate>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>

        <div class="mdc-drawer-scrim"></div>

        <div class="mdc-drawer-app-content w-full">
            <slot name="content"></slot>
        </div>
    </div>
</template>

<script>
import {MDCDrawer} from "@material/drawer/component";
import Helpers from "../../services/Helpers";
import AuthRepository from "../../apiRepositories/AuthRepository";
import StoryRepository from "../../repositories/StoryRepository";
import GameData from "../../services/GameData";

const md5 = require('js-md5');

export default {
    inject: ['appData'],
    data() {
        return {
            game: null,
            hasMap: true,
            drawer: null,
            list: null,
            user: null,
            currentRoute: null,
            stopToggle: false,
            loggedIn: Helpers.loggedIn(),
            showCampaignSwitch: false,
            auth: new AuthRepository(),
            gameData: new GameData(),
            storyRepository: new StoryRepository
        }
    },
    mounted() {
        this.setGame();
        this.drawer = MDCDrawer.attachTo(this.$refs['menu']);
        this.$bus.$on('campaigns-changed', this.setUser);
        this.$bus.$on('game-selected', this.setGame);
    },
    methods: {
        toggle() {
            if (this.stopToggle) {
                return;
            }

            this.drawer.open = !this.drawer.open;
            if (this.drawer.open) {
                this.currentRoute = this.$router.currentRoute.path;
                this.stopToggle = false;

                // load campaign options
                if (this.showCampaignSwitch) {
                    this.$refs['campaign-switch'].applyData();
                }
            }
        },
        preventToggle() {
            this.stopToggle = true;
            setTimeout(() => {
                this.stopToggle = false;
            }, 10);
        },
        async logout() {
            this.auth.logout();
            await app.switchCampaign('local');

            location.reload();
        },
        setGame(game) {
            this.game = game || this.appData.game;
            this.hasMap = this.gameData.map(this.game) !== null;
        },
        setUser() {
            this.user = app.user;

            if (this.user && this.shouldOpenShare()) {
                this.shareCurrentStory();
                Helpers.removeQueryString();
            }

            this.showCampaignSwitch = app.stories.count() > 0;
            this.setGame();
        },
        shouldOpenShare() {
            return location.search.includes('share');
        },
        gravatar() {
            const hash = md5(this.user.email);
            return `https://www.gravatar.com/avatar/${hash}?d=identicon`;
        },
        shareCurrentStory() {
            if (app.campaignId === 'local') {
                this.$bus.$emit('open-share-modal');
            } else {
                this.$bus.$emit('open-share-campaign-code-modal', this.storyRepository.current());
            }
        }
    }
}
</script>

<style scoped lang="scss">
.mdc-drawer__content {
    overflow-x: hidden;
}
</style>
